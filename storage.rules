rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    /* ---------- helpers ---------- */
    function isSignedIn() {
      return request.auth != null;
    }

    // Owner check via Firestore document at recipes/{recipeId}
    function isRecipeOwner(recipeId) {
      return isSignedIn()
        && exists(/databases/(default)/documents/recipes/$(recipeId))
        && get(/databases/(default)/documents/recipes/$(recipeId)).data.uid == request.auth.uid;
    }

    /* =========================================================
       POSTS media — store under: posts/{uid}/{postId}/...
       (Allows nested files/folders)
    ========================================================== */
    match /posts/{uid}/{postId}/{allPaths=**} {
      allow read: if true; // public reads (adjust if you want)
      allow write: if isSignedIn() && request.auth.uid == uid; // owner can upload/delete
    }

    /* =========================================================
       RECIPE images — cover + gallery
       Paths:
         - recipeImages/{uid}/{recipeId}/cover
         - recipeImages/{uid}/{recipeId}/gallery/{imageId}
    ========================================================== */
    match /recipeImages/{uid}/{recipeId}/{fileId=**} {
      // Anyone signed-in can view; writes restricted to owner uid
      allow read: if isSignedIn();
      allow write, delete: if isSignedIn() && request.auth.uid == uid;
      // Optional: allow listing “folders” if you use list()
      allow list: if isSignedIn() && request.auth.uid == uid;
    }

    /* =========================================================
       (Optional) Back-compat if you previously used:
         recipes/{uid}/{recipeId}/...
       Keep until you migrate everything to recipeImages/...
    ========================================================== */
    match /recipes/{uid}/{recipeId}/{allPaths=**} {
      allow read: if true;
      allow write: if isRecipeOwner(recipeId) && request.auth.uid == uid;
    }

    /* ---------- deny everything else ---------- */
    match /{allOtherPaths=**} {
      allow read, write: if false;
    }
  }
}
