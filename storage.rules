rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    /* ---------- helpers ---------- */
    function isSignedIn() {
      return request.auth != null;
    }

    // Owner check via Firestore document at recipes/{recipeId}
    function isRecipeOwner(recipeId) {
      return isSignedIn()
        && exists(/databases/(default)/documents/recipes/$(recipeId))
        && get(/databases/(default)/documents/recipes/$(recipeId)).data.uid == request.auth.uid;
    }
    /* =========================================================
       avatars/{uid}/... — profile photos
       Owner can write/delete; anyone signed-in can read (or make public if you want)
    ========================================================== */
    match /avatars/{uid}/{allPaths=**} {
      allow read: if true; // or: request.auth != null
      allow write, delete: if request.auth != null && request.auth.uid == uid;
      allow list: if request.auth != null && request.auth.uid == uid; // optional
    }

    /* =========================================================
       POSTS media — store under: posts/{uid}/{postId}/...
       (Allows nested files/folders)
    ========================================================== */
    match /posts/{uid}/{postId}/{allPaths=**} {
      allow read: if true; // public reads (adjust if you want)
      allow write: if isSignedIn() && request.auth.uid == uid; // owner can upload/delete
    }

    /* =========================================================
       RECIPE images — cover + gallery
       Paths:
         - recipeImages/{uid}/{recipeId}/cover
         - recipeImages/{uid}/{recipeId}/gallery/{imageId}
    ========================================================== */
    match /recipeImages/{uid}/{recipeId}/{fileId=**} {
      // Anyone signed-in can view; writes restricted to owner uid
      allow read: if isSignedIn();
      allow write, delete: if isSignedIn() && request.auth.uid == uid;
      // Optional: allow listing “folders” if you use list()
      allow list: if isSignedIn() && request.auth.uid == uid;
    }

    /* =========================================================
       (Optional) Back-compat if you previously used:
         recipes/{uid}/{recipeId}/...
       Keep until you migrate everything to recipeImages/...
    ========================================================== */
    match /recipes/{uid}/{recipeId}/{allPaths=**} {
      allow read: if true;
      allow write: if isRecipeOwner(recipeId) && request.auth.uid == uid;
    }

    /* ---------- deny everything else ---------- */
    match /{allOtherPaths=**} {
      allow read, write: if false;
    }
  }
   // Only the owner can read/write their avatar; 5 MB cap; image only
    match /avatars/{uid}/{file=**} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null
                   && request.auth.uid == uid
                   && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/(png|jpe?g|webp)');
    }

    // (Optional) posts media
    match /posts/{uid}/{postId}/{file=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == uid
                   && request.resource.size < 20 * 1024 * 1024
                   && (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType.matches('video/.*'));
    }
  
}
